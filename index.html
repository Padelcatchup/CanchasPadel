<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PadelMap BA – Encuentra tu próxima cancha</title>

  <!-- Tailwind & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" />

  <!-- Leaflet + plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

  <!-- Sheet‑JS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --grad-1:#667eea; --grad-2:#764ba2; --accent:#4ecdc4; --danger:#e53935; --primary:#43cea2; --primary-2:#185a9d; --warn:#ff6b6b; }
    *,*::before,*::after{ box-sizing:border-box; margin:0; padding:0; }
    body{ font-family:'Poppins',sans-serif; background:linear-gradient(135deg,var(--grad-1) 0%,var(--grad-2) 100%); min-height:100vh; overflow:hidden; }

    .app{ display:flex; height:100vh; }
    .sidebar{ width:380px; max-width:90vw; background:rgba(255,255,255,.95); backdrop-filter:blur(20px); padding:24px; overflow-y:auto; position:relative; transition:.3s; }
    .sidebar.collapsed{ width:90px; padding:24px 12px; }
    .sidebar.collapsed .hide-on-collapse{ opacity:0; pointer-events:none; }
    .map-wrapper{ flex:1; position:relative; }
    #map{ width:100%; height:100%; }

    .btn{ width:100%; padding:12px; border-radius:0.5rem; font-weight:600; display:flex; align-items:center; justify-content:center; gap:.5rem; transition:transform .15s; }
    .btn:active{ transform:scale(.97); }
    .btn-primary{ background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; }
    .btn-primary:hover{ filter:brightness(1.05); box-shadow:0 4px 15px rgba(67,206,162,.4); }
    .btn-danger{ background:linear-gradient(135deg,#ff512f,#f09819); color:#fff; }
    .btn-danger:hover{ filter:brightness(1.05); box-shadow:0 4px 15px rgba(255,81,47,.4); }

    .toggle{ position:absolute; top:20px; right:-16px; width:34px; height:34px; border-radius:50%; border:none; background:linear-gradient(135deg,var(--grad-1),var(--grad-2)); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.3s; z-index:1001; }
    .sidebar.collapsed .toggle{ transform:rotate(180deg); }

    #loader{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.65); backdrop-filter:blur(4px); z-index:1002; }
    #loader::before{ content:""; width:46px; height:46px; border-radius:50%; border:5px solid var(--accent); border-top-color:transparent; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); opacity:0; visibility:hidden; transition:.3s; z-index:1100; }
    #overlay.show{ opacity:1; visibility:visible; }
    #card{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.6); width:94%; max-width:540px; max-height:90vh; overflow-y:auto; background:rgba(255,255,255,.96); backdrop-filter:blur(20px); border-radius:24px; padding:32px; box-shadow:0 20px 60px rgba(0,0,0,.25); transition:.35s cubic-bezier(.175,.885,.32,1.275); z-index:1101; }
    #card.show{ transform:translate(-50%,-50%) scale(1); }

    @media(max-width:768px){ .sidebar{ position:absolute; left:-100%; top:0; height:100%; border-radius:0; } .sidebar.show{ left:0; } .mobile-btn{ position:absolute; top:20px; left:20px; width:50px; height:50px; border-radius:50%; background:rgba(255,255,255,.9); display:flex; align-items:center; justify-content:center; z-index:1003; } }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <button class="toggle hidden md:flex" onclick="toggleSidebar()"><i class="fas fa-angle-left"></i></button>

      <div class="hide-on-collapse">
        <h1 class="text-3xl font-extrabold bg-gradient-to-r from-pink-500 to-teal-400 bg-clip-text text-transparent text-center mb-6"><i class="fas fa-table-tennis-paddle-ball mr-2"></i>PadelMap BA</h1>
        <!-- Zona -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-600 mb-1"><i class="fas fa-globe-americas mr-1"></i>Zona</label>
          <select id="zoneSelect" class="w-full py-3 px-4 rounded-lg bg-white bg-opacity-80 focus:bg-opacity-95 focus:ring-2 focus:ring-accent focus:outline-none" onchange="applyFilters()"></select>
        </div>
        <!-- Localidad -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-600 mb-1"><i class="fas fa-location-dot mr-1"></i>Localidad</label>
          <input id="localitySearch" list="localities" placeholder="Buscar localidad…" class="w-full py-3 px-4 rounded-lg bg-white bg-opacity-80 focus:bg-opacity-95 focus:ring-2 focus:ring-accent focus:outline-none" oninput="applyFilters()">
          <datalist id="localities"></datalist>
        </div>
        <!-- Actions -->
        <button class="btn btn-primary mb-3" onclick="getCurrentLocation()"><i class="fas fa-location-crosshairs"></i>Mi ubicación</button>
        <button class="btn btn-danger mb-8" onclick="resetFilters()"><i class="fas fa-arrows-rotate"></i>Limpiar filtros</button>
        <!-- Stats -->
        <div class="text-center bg-white bg-opacity-70 rounded-xl py-4 mb-6">
          <span id="count" class="text-4xl font-extrabold text-accent">0</span>
          <p class="text-sm text-gray-600 font-medium">Canchas disponibles</p>
        </div>
        <!-- Nearest -->
        <section id="nearestBox" class="hidden">
          <h3 class="text-gray-700 font-semibold mb-3 flex items-center"><i class="fas fa-route mr-2"></i>Canchas más cercanas</h3>
          <div id="nearest" class="space-y-3"></div>
        </section>
      </div>
    </aside>

    <!-- Map -->
    <div class="map-wrapper">
      <button class="mobile-btn md:hidden" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      <div id="map"></div>
      <div id="loader"></div>
    </div>
  </div>

  <!-- Card & Overlay -->
  <div id="overlay" onclick="closeCard()"></div>
  <article id="card"></article>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <script>
    /*────────── CONFIG ─────────*/
    const EXCEL_URL = 'PadelGeo.xlsx';
    const DANGER_COLOR = '#e53935';
    const ZONE_COLORS = { 'CABA':'#ff6b6b', 'GBA Norte':'#4ecdc4', 'GBA Sur':'#ffd166', 'GBA Oeste':'#118ab2' };

    /*────────── STATE */
    let courts=[], filtered=[]; let map, cluster, userLoc=null, userMarker=null;

    /*────────── HELPERS */
    const canon = s=>String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'');
    const pick=(row,...aliases)=>{ const keys=Object.keys(row); for(const a of aliases){ const k=keys.find(k=>canon(k).includes(canon(a))); if(k!==undefined) return row[k]; } return ''; };
    const firstVal=row=>Object.values(row)[0];
    const distKm=(a,b)=>{const R=6371,dLat=(b.lat-a.lat)*Math.PI/180,dLng=(b.lng-a.lng)*Math.PI/180,s=Math.sin(dLat/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;return 2*R*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));};

    /*────────── EXCEL */
    async function loadExcel(){
      const res=await fetch(EXCEL_URL); if(!res.ok) throw new Error('Excel download fail');
      const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});
      return rows.map(r=>{
        const name = pick(r,'nombre','cancha','complejo','club') || firstVal(r) || 'N/D';
        return {
          name,
          address:   pick(r,'direccion','calle','domicilio') || 'N/D',
          locality:  pick(r,'localidad','ciudad','poblacion') || 'N/D',
          zone:      pick(r,'zona','region','partido','area') || 'Sin zona',
          phone:     pick(r,'telefono','tel'),
          instagram: pick(r,'instagram','ig'),
          instagramUrl: pick(r,'instagramurl','urlinstagram','linkig'),
          reservation:  pick(r,'linkreserva','reserva','booking'),
          lat: parseFloat(pick(r,'latitud','lat','latitude')),
          lng: parseFloat(pick(r,'longitud','lon','lng','longitude')),
          image: pick(r,'imagen','foto','image')
        };
      }).filter(c=>!isNaN(c.lat)&&!isNaN(c.lng));
    }

    /*────────── MAP */
    const icon=(c)=>L.divIcon({html:`<i class='fas fa-map-marker-alt' style='color:${ZONE_COLORS[c.zone]||'#555'};font-size:24px'></i>`,className:'',iconSize:[24,24],iconAnchor:[12,24]});

    function initMap(){
      map=L.map('map').setView([-34.6037,-58.3816],11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
      cluster=L.markerClusterGroup(); map.addLayer(cluster);
      renderMarkers();
    }

    function renderMarkers(){
      cluster.clearLayers();
      filtered.forEach(c=>{
        const m=L.marker([c.lat,c.lng],{icon:icon(c)});
        m.bindPopup(`<strong>${c.name}</strong><br><span class='text-xs'>${c.locality}</span>`);
        m.on('click',()=>openCard(c)); // click instead of dblclick
        cluster.addLayer(m);
      });
      document.getElementById('count').textContent=filtered.length;
      if(userLoc) updateNearest();
    }

    /*────────── FILTERS */
    function buildFilters(){
      const zoneSel=document.getElementById('zoneSelect');
      const zones=[...new Set(courts.map(c=>c.zone).filter(z=>z&&z!=='Sin zona'))].sort();
      zoneSel.innerHTML='<option value="">Todas las zonas</option>'+zones.map(z=>`<option value="${z}">${z}</option>`).join('');
      const locs=[...new Set(courts.map(c=>c.locality))].sort();
      document.getElementById('localities').innerHTML=locs.map(l=>`<option value="${l}">`).join('');
    }

    function applyFilters(){
      const z=document.getElementById('zoneSelect').value;
      const loc=document.getElementById('localitySearch').value.trim().toLowerCase();
      filtered=courts.filter(c=>(!z||c.zone===z)&&(!loc||c.locality.toLowerCase().includes(loc)));
      renderMarkers();
    }

    function resetFilters(){ document.getElementById('zoneSelect').value=''; document.getElementById('localitySearch').value=''; filtered=[...courts]; renderMarkers(); }

    /*────────── USER LOCATION */
    function getCurrentLocation(){
      if(!navigator.geolocation) return alert('Geolocalización no soportada');
      navigator.geolocation.getCurrentPosition(p=>{userLoc={lat:p.coords.latitude,lng:p.coords.longitude}; showUserMarker(); map.setView([userLoc.lat,userLoc.lng],13); updateNearest();},e=>alert('Error: '+e.message));
    }

    function showUserMarker(){ if(userMarker) map.removeLayer(userMarker); userMarker=L.marker([userLoc.lat,userLoc.lng],{icon:L.divIcon({html:`<i class='fas fa-map-marker-alt' style='color:${DANGER_COLOR};font-size:26px'></i>`,iconSize:[26,26],iconAnchor:[13,26]})}).bindPopup('Tu ubicación').addTo(map).openPopup(); }

    function updateNearest(){
      const list=filtered.map(c=>({...c,d:distKm(userLoc,c)})).sort((a,b)=>a.d-b.d).slice(0,3);
      nearest.innerHTML=list.map(c=>`<div class='bg-white bg-opacity-70 rounded-lg p-3 cursor-pointer hover:bg-opacity-90' onclick='map.setView([${c.lat},${c.lng}],15); openCard(${JSON.stringify(c).replace(/\"/g,'&quot;')})'><p class='font-semibold text-gray-800 text-sm'>${c.name}</p><p class='text-gray-600 text-xs'>${c.locality}</p><p class='text-accent font-medium text-xs'>${c.d.toFixed(2)} km</p></div>`).join('');
      document.getElementById('nearestBox').classList.toggle('hidden',list.length===0);
    }

    /*────────── CARD */
    function openCard(c){
      const overlay=document.getElementById('overlay');
      const card=document.getElementById('card');
      overlay.classList.add('show'); card.classList.add('show');
      const phone=c.phone?`<li class='flex gap-2'><i class='fas fa-phone text-accent'></i><span><strong>Teléfono:</strong> <a href='tel:${c.phone}' class='text-primary-600'>${c.phone}</a></span></li>`:'';
      const dist=userLoc?`<li class='flex gap-2'><i class='fas fa-route text-accent'></i><span><strong>Distancia:</strong> ${distKm(userLoc,c).toFixed(2)} km</span></li>`:'';
      card.innerHTML=`<button class='absolute top-4 right-4 w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center' onclick='closeCard()'><i class='fas fa-times'></i></button>
        <h2 class='text-2xl font-bold text-center mb-1'>${c.name}</h2>
        <p class='text-center text-accent mb-4'>${c.zone}</p>
        <ul class='space-y-2 text-sm mb-4'>
          <li class='flex gap-2'><i class='fas fa-map-marker-alt text-accent'></i><span><strong>Dirección:</strong> ${c.address}</span></li>
          <li class='flex gap-2'><i class='fas fa-city text-accent'></i><span><strong>Localidad:</strong> ${c.locality}</span></li>
          ${phone}
          ${c.instagram?`<li class='flex gap-2'><i class='fab fa-instagram text-accent'></i><span><strong>Instagram:</strong> <a href='${c.instagramUrl||'#'}' target='_blank' class='text-primary-600'>${c.instagram}</a></span></li>`:''}
          ${c.reservation?`<li class='flex gap-2'><i class='fas fa-calendar-check text-accent'></i><span><strong>Reservas:</strong> <a href='${c.reservation}' target='_blank' class='text-primary-600 font-semibold'>Reservar</a></span></li>`:''}
          ${dist}
        </ul>
        ${c.image?`<img src='${c.image}' alt='${c.name}' class='rounded-xl object-cover w-full max-h-64'>`:''}`;
    }
    const closeCard=()=>{overlay.classList.remove('show');card.classList.remove('show');};

    /*────────── SIDEBAR */
    function toggleSidebar(){const sb=document.getElementById('sidebar'); if(innerWidth<=768){sb.classList.toggle('show');}else{sb.classList.toggle('collapsed');}}
    addEventListener('resize',()=>{ if(innerWidth>768) document.getElementById('sidebar').classList.remove('show'); });

    /*────────── INIT */
    (async()=>{
      try{ courts=await loadExcel(); filtered=[...courts]; buildFilters(); initMap(); }
      catch(e){ console.error(e); alert('Error al cargar las canchas'); }
      finally{ document.getElementById('loader').style.display='none'; }
    })();
  </script>
</body>
</html>
